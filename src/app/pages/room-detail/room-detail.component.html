@if (vm$ | async; as vm) {

  <h2>Room {{ vm.room?.id }}</h2>
  <p>Statut: {{ vm.room?.state || '‚Äî' }} ‚Äî Mode: {{ vm.room?.mode || '‚Äî' }}</p>
  <button (click)="confirmDelete()" class="danger">üóëÔ∏è Supprimer cette room</button>

  <h3>Carte temps r√©el</h3>
  <!-- La carte lit l'id via la route; si tu veux, tu peux aussi lui passer [roomId]="vm.room?.id" si le composant le supporte -->
  <app-room-live-map></app-room-live-map>

  <!-- ====== PLAYERS (via players$ dans le VM) ====== -->
  <h3>Joueurs ({{ vm.players?.length || 0 }})</h3>
  @if (vm.players?.length) {
    <ul>
      @for (p of vm.players; track p.uid) {
        <li>
          <strong>{{ p.displayName || p.uid }}</strong>
          ‚Äî r√¥le: <b>{{ p.role || '‚Äî' }}</b>
          <span *ngIf="p.score !== undefined"> ‚Äî score: {{ p.score }}</span>
        </li>
      }
    </ul>
  } @else {
    <em>Aucun joueur</em>
  }

  <!-- Debug facultatif -->
  <pre class="muted" style="white-space:pre-wrap">{{ vm.players | json }}</pre>

  <!-- ====== BOTS (monitor -> RTDB) ====== -->
  <h3>Bots (monitor ‚Üí RTDB)</h3>
  <div class="bots">
    <button (click)="addBot()">+ Ajouter un bot</button>

    <ul>
      @for (b of (bots$ | async); track b.id) {
        <li
          [class.selected]="b.id === selectedBotId"
          (click)="selectBot(b.id)">
          <strong>{{ b.displayName || b.id }}</strong>
          ‚Äî ({{ b.x ?? 0 }}, {{ b.y ?? 0 }})
          @if (b.id === selectedBotId) { <span> ‚Üê s√©lectionn√©</span> }
        </li>
      }
    </ul>

    @if (selectedBotId; as id) {
      <div class="controls">
        <p>Contr√¥les pour: <code>{{ id }}</code></p>
        <div class="pad">
          <button (click)="step(0,-1)">‚Üë</button>
          <div>
            <button (click)="step(-1,0)">‚Üê</button>
            <button (click)="step(1,0)">‚Üí</button>
          </div>
          <button (click)="step(0,1)">‚Üì</button>
        </div>
        <button (click)="toggleRandom()">Al√©atoire ON/OFF</button>
      </div>
    }
  </div>

  <h3>Positions (live ou spawn)</h3>
  <ul>
    @for (p of (positions$ | async); track p.id) {
      <li>
        <code [style.opacity]="p.isBot ? 0.7 : 1">{{ p.id }}</code>
        ‚Äî ({{ p.x | number:'1.0-2' }}, {{ p.y | number:'1.0-2' }})
        @if (p.isBot) { <span>[bot]</span> }
      </li>
    }
  </ul>

  <!-- ====== DIAGNOSTIC ====== -->
  <h3>Diagnostic droits</h3>
  <div class="diag">
    <button (click)="runDiag()">‚ñ∂ Rafra√Æchir</button>
    <button (click)="tryWriteTest()">‚úç Test √©criture bots</button>
    <ul>
      <li><b>auth.uid</b> = {{ diag.uid || '‚Äî' }}</li>
      <li><b>roomsMeta/{{ vm.room?.id }}/ownerUid</b> = {{ diag.ownerUid || '‚Äî' }}</li>
      <li><b>write bots</b> = {{ diag.canWriteBots }}</li>
    </ul>
  </div>

  <p><a [routerLink]="['/rooms']">‚Üê Retour</a></p>

} @else {
  <p>Room introuvable.</p>
}
