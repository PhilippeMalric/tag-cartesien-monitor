@if (room$ | async; as room) {

  <h2>Room {{ room.id }}</h2>
  <p>Statut: {{ room.state }} — Mode: {{ room.mode }}</p>

  <h3>Carte temps réel</h3>
  <app-room-live-map></app-room-live-map>

  @if (room.lastEventAt) {
    <p>Dernier évènement: {{ room.lastEventAt | date:'short' }}</p>
  }

  <h3>Joueurs</h3>
  <ul>
    <li *ngFor="let uid of room.uids">{{ uid }}</li>
  </ul>

  <!-- ====== BOTS (monitor -> RTDB) ====== -->
  <h3>Bots (monitor → RTDB)</h3>
  <div class="bots">
    <button (click)="addBot()">+ Ajouter un bot</button>

    <ul>
      <li *ngFor="let b of (bots$ | async)"
          [class.selected]="b.id === selectedBotId"
          (click)="selectBot(b.id)">
        <strong>{{ b.displayName || b.id }}</strong>
        — ({{ b.x ?? 0 }}, {{ b.y ?? 0 }})
        <span *ngIf="b.id === selectedBotId"> ← sélectionné</span>
      </li>
    </ul>

    <div class="controls" *ngIf="selectedBotId as id">
      <p>Contrôles pour: <code>{{ id }}</code></p>
      <div class="pad">
        <button (click)="step(0,-1)">↑</button>
        <div>
          <button (click)="step(-1,0)">←</button>
          <button (click)="step(1,0)">→</button>
        </div>
        <button (click)="step(0,1)">↓</button>
      </div>
      <button (click)="toggleRandom()">Aléatoire ON/OFF</button>
    </div>
  </div>

<h3>Positions (live)</h3>
<ul>
  <li *ngFor="let p of (positions$ | async)">
    <code [style.opacity]="p.isBot ? 0.7 : 1">{{ p.id }}</code>
    — ({{ p.x | number:'1.0-2' }}, {{ p.y | number:'1.0-2' }})
    <span *ngIf="p.isBot">[bot]</span>
  </li>
</ul>

  <!-- ====== DIAGNOSTIC ====== -->
  <h3>Diagnostic droits</h3>
  <div class="diag">
    <button (click)="runDiag()">▶ Rafraîchir</button>
    <button (click)="tryWriteTest()">✍ Test écriture bots</button>
    <ul>
      <li><b>auth.uid</b> = {{ diag.uid || '—' }}</li>
      <li><b>roomsMeta/{{ room.id }}/ownerUid</b> = {{ diag.ownerUid || '—' }}</li>
      <li><b>write bots</b> = {{ diag.canWriteBots }}</li>
    </ul>
  </div>

  <p><a [routerLink]="['/rooms']">← Retour</a></p>
} @else {
  <p>Room introuvable.</p>
}
