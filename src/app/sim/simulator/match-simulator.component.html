<mat-card class="sim-card" appearance="outlined">
  <mat-card-header>
    <mat-card-title>Simulation de partie</mat-card-title>
    <mat-card-subtitle>RTDB bots + positions, TAG via MatchService</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>

    <!-- AUCUNE ROOM → on propose créer et/ou sélectionner -->
    @if (!roomId()) {
      <app-create-room
        [name]="newRoomName()"
        (nameChange)="newRoomName.set($event)"
        (create)="createRoomAndUseIt()">
      </app-create-room>

      <mat-divider style="margin:12px 0;"></mat-divider>

      <app-room-select
        [value]="roomId()"
        (valueChange)="roomId.set($event)">
      </app-room-select>

      <!-- Optionnel : petit hint -->
      <p style="margin-top:12px; opacity:.7">
        Choisis une room (ou crée-en une) pour afficher les contrôles de simulation.
      </p>
    }

    <!-- ROOM SÉLECTIONNÉE → on affiche tout le reste -->
    @if (roomId()) {
      <!-- garder la sélection visible pour changer de room à la volée -->
      <app-room-select
        [value]="roomId()"
        (valueChange)="roomId.set($event)">
      </app-room-select>

      <!-- 1) Room -->
      <app-room-input
        [roomId]="roomId()"
        (roomIdChange)="roomId.set($event)"
        (listen)="listen()"
        (unlisten)="unlisten()">
      </app-room-input>
      
 <mat-divider class="m12"></mat-divider>

    <div class="match-state">
        <mat-chip-set>
          <mat-chip [color]="statusSig().color" selected>
            <mat-icon inline>
              {{ statusSig().state === 'running' ? 'play_circle' : (statusSig().state === 'idle' ? 'schedule' : 'flag') }}
            </mat-icon>
            {{ statusSig().label }}
          </mat-chip>
          @if (statusSig().state === 'running' && statusSig().leftMs != null) {
            <mat-chip>⏱ {{ fmtTime(statusSig().leftMs) }}</mat-chip>
          }
        </mat-chip-set>

        @if (statusSig().state === 'running' && statusSig().progress01 != null) {
          <mat-progress-bar
            mode="determinate"
            [value]="(statusSig().progress01 ?? 0) * 100">
          </mat-progress-bar>
        }
      </div>

  <app-players-controls [roomId]="roomId()"></app-players-controls>

      <!-- 2) Bots -->
      <app-bots-controls
        [nbBots]="nbBots()"
        (nbBotsChange)="nbBots.set($event)"
        [speed]="speed()"
        (speedChange)="speed.set($event)"
        [displayMs]="displayMs"
        (spawn)="spawnBots()">
      </app-bots-controls>

      <!-- 3) TAG -->
      @if (dots$ | async; as dots) {
        <app-tag-controls
          [dots]="dots"
          [victimUid]="victimUid()"
          (victimUidChange)="victimUid.set($event)"
          (simulate)="simulateTag(dots)">
        </app-tag-controls>
      }
<div class="actions-row" style="display:flex; gap:8px; align-items:center; margin:12px 0;">
  <button mat-flat-button color="primary" (click)="start()">
    <mat-icon>play_arrow</mat-icon>
    Démarrer
  </button>

  <button mat-stroked-button color="warn" (click)="stop()">
    <mat-icon>stop</mat-icon>
    Terminer
  </button>
</div>
         <!-- 4) Canvas -->
    <app-field-canvas
    [roomId]="roomId()"
    [world]="{ minX:-45, maxX:45, minY:-30, maxY:30 }">
  </app-field-canvas>

    <app-numeric-positions [roomId]="roomId()"></app-numeric-positions>
<app-sim-event-feed [roomId]="roomId()"></app-sim-event-feed>

    }

  </mat-card-content>
</mat-card>
